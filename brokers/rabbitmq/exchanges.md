## Exchange

Exchanges - сущности [AMQP 0-9-1](init.md), в которые посылаются сообщения.

Типы по модели AMQP 0-9-1
* Direct
* Fanout
* Topic
* Headers (match)

Основные параметры exchange:
* Имя
* Долговечность (сохраняется ли после рестарта брокера) [durabilty]
* Автоудаление
* Аргументы (опциональные, используемые плагинами)

# Exchange по умолчанию

Exchange по умолчанию - direct без имени (пустая строка), предварительно объявленный брокером. У него есть одно особое свойство, которое делает его очень полезным для простых приложений: каждая создаваемая очередь автоматически привязывается к ней с помощью ключа маршрутизации, который совпадает с именем очереди.

Например, когда вы объявляете очередь с именем "search-indexing-online", брокер AMQP 0-9-1 свяжет ее с exchange по умолчанию, используя "search-indexing-online" в качестве ключа маршрутизации (в этом контексте иногда упоминается как binding key). Таким образом, сообщение, опубликованное на сервере exchange по умолчанию с ключом маршрутизации "search-indexing-online", будет перенаправлено в очередь "search-indexing-online". Другими словами, обмен по умолчанию создает впечатление, что можно доставлять сообщения непосредственно в очереди, хотя технически это не так.

# Direct Exchange

Прямой обмен доставляет сообщения в очереди на основе ключа маршрутизации сообщений. Прямой обмен идеально подходит для одноадресной маршрутизации сообщений (хотя их можно использовать и для многоадресной маршрутизации). Вот как это работает:

Очередь привязывается к обмену с помощью ключа маршрутизации __K__
Когда новое сообщение с ключом маршрутизации __R__ поступает на прямой обмен, обмен направляет его в очередь, если __K__ = __R__

Direct exchange часто используются для распределения задач между несколькими worker'ами (экземплярами одного и того же приложения) циклическим способом. При этом важно понимать, что в AMQP 0-9-1 сообщения распределяются по нагрузке между consumer'ами, а не между очередями.

![image](assets/exchange-direct.png)

# Fanout Exchange

Fanout exchange доставляет сообщения во все очереди, которые к нему привязаны, а ключ маршрутизации игнорируется. Если N очередей привязаны к разветвленному exchange, то при публикации нового сообщения на этом exchange копия сообщения доставляется во все N очередей. Разветвленные exchange идеально подходят для широковещательной маршрутизации сообщений:

Поскольку разветвленный exchange доставляет копию сообщения в каждую очередь, связанную с ним, его варианты использования очень похожи:

* Многопользовательские онлайн-игры (MMO) могут использовать его для обновления таблицы лидеров или других глобальных событий
* Сайты спортивных новостей могут использовать fanout exchange для распространения обновлений результатов среди мобильных клиентов практически в режиме реального времени
* Распределенные системы могут транслировать различные обновления состояния и конфигурации.
* Групповые чаты могут распространять сообщения между участниками, используя разветвленный exchange (хотя AMQP не имеет встроенной концепции присутствия [concept of presence], поэтому XMPP может быть лучшим выбором).

![image](assets/exchange-fanout.png)


# Topic Exchange

Topic Exchange доставляет сообщения в одну или несколько очередей на основе соответствия между ключом маршрутизации сообщений и шаблоном, который использовался для привязки очереди к exchange. Тип topic exchange часто используется для реализации различных вариантов шаблонов публикации/подписки [pub/sub]. Topic Exchange обычно используется для многоадресной маршрутизации сообщений.

Topic exchanges имеют очень широкий набор вариантов использования. Всякий раз, когда проблема связана с несколькими consumer'ами /приложениями, которые выборочно выбирают, какой тип сообщений они хотят получать, следует рассмотреть возможность использования topic exchange.

Пример использования:

* Распространение данных, относящихся к определенному географическому местоположению, например, к торговым точкам
* Фоновая обработка задач выполняется несколькими работниками, каждый из которых способен обрабатывать определенный набор задач
* Обновления цен на акции (и обновления других видов финансовых данных)
* Обновления новостей, которые включают категоризацию или пометку (например, только для определенного вида спорта или команды)
* Организация различных сервисов в облаке
* Распределенная архитектура / специфичные для ОС сборки или упаковки программного обеспечения, в которых каждый разработчик может обрабатывать только одну архитектуру или ОС

# Headers Exchange

Headers exchange предназначен для маршрутизации по нескольким атрибутам, которые легче выразить в виде заголовков сообщений, чем в виде ключа маршрутизации. Headers exchange игнорирует атрибут ключа маршрутизации. Вместо этого атрибуты, используемые для маршрутизации, берутся из атрибута headers. Сообщение считается совпадающим, если значение заголовка равно значению, указанному при привязке.

Можно привязать очередь к headers exchange, используя для сопоставления более одного заголовка. В этом случае брокеру требуется еще одна информация от разработчика приложения, а именно, должен ли он рассматривать сообщения с любым из совпадающих заголовков или со всеми из них? Это то, для чего предназначен аргумент привязки "x-match". Когда для аргумента "x-match" установлено значение "any", достаточно только одного совпадающего значения заголовка. В качестве альтернативы, установка "x-match" на "all" требует, чтобы все значения должны совпадать.

Для "any" и "all" заголовки, начинающиеся со строки x-, не будут использоваться для оценки совпадений. Установка "x-match" на "any-with-x" или "all-with-x" также будет использовать заголовки, начинающиеся со строки x- для оценки совпадений.

Headers exchange можно рассматривать как "direct exchange на стероидах". Поскольку они маршрутизируют на основе значений заголовка, их можно использовать в качестве direct exchange, где ключ маршрутизации не обязательно должен быть строкой; например, это может быть целое число или хэш (словарь).

[Источник](https://www.rabbitmq.com/tutorials/amqp-concepts.html)